openapi: 3.0.3
info:
  title: Whereish API
  description: |
    Privacy-first semantic location sharing API.

    All sensitive data (locations, named places, permissions) is encrypted client-side.
    The server stores encrypted blobs it cannot read, acting as a secure relay.
  version: 1.0.0
  contact:
    name: Whereish
  license:
    name: MIT

servers:
  - url: /api
    description: API base path

tags:
  - name: auth
    description: Authentication and session management
  - name: identity
    description: Encrypted identity backup and public key management
  - name: user-data
    description: Encrypted user data blob (places, permissions, preferences)
  - name: contacts
    description: Contact relationships and requests
  - name: locations
    description: Encrypted location sharing between contacts
  - name: devices
    description: Device registration and revocation

security:
  - bearerAuth: []

paths:
  /health:
    get:
      operationId: getHealth
      summary: Health check
      description: Returns server health status. No authentication required.
      tags: [auth]
      security: []
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /auth/google:
    post:
      operationId: loginWithGoogle
      summary: Login with Google OAuth
      description: |
        Exchange a Google OAuth ID token for a Whereish session.
        Creates user account if first login.
      tags: [auth]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GoogleLoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/logout:
    post:
      operationId: logout
      summary: End current session
      description: Invalidates the current session token.
      tags: [auth]
      responses:
        '204':
          description: Logout successful
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/account:
    delete:
      operationId: deleteAccount
      summary: Delete user account
      description: |
        Permanently deletes the user account and all associated data.
        This action cannot be undone.
      tags: [auth]
      responses:
        '204':
          description: Account deleted
        '401':
          $ref: '#/components/responses/Unauthorized'

  /me:
    get:
      operationId: getCurrentUser
      summary: Get current user info
      description: Returns information about the authenticated user.
      tags: [auth]
      responses:
        '200':
          description: Current user info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /identity/backup:
    get:
      operationId: getIdentityBackup
      summary: Get encrypted identity backup
      description: |
        Retrieves the user's encrypted identity backup.
        The backup is encrypted with a PIN-derived key and contains the user's keypair.
      tags: [identity]
      responses:
        '200':
          description: Encrypted identity backup
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IdentityBackup'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: No identity backup exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      operationId: setIdentityBackup
      summary: Store encrypted identity backup
      description: |
        Stores the user's encrypted identity backup.
        The backup should be encrypted client-side with a PIN-derived key.
      tags: [identity]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IdentityBackup'
      responses:
        '204':
          description: Identity backup stored
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /identity/public-key:
    post:
      operationId: setPublicKey
      summary: Register public key
      description: |
        Registers the user's public key for end-to-end encryption.
        Other users encrypt location data to this key.
      tags: [identity]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PublicKeyRequest'
      responses:
        '204':
          description: Public key registered
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /user-data:
    get:
      operationId: getUserData
      summary: Get encrypted user data
      description: |
        Retrieves the user's encrypted data blob containing named locations,
        contact permissions, and preferences.
      tags: [user-data]
      responses:
        '200':
          description: Encrypted user data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserData'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: No user data exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      operationId: setUserData
      summary: Update encrypted user data
      description: |
        Updates the user's encrypted data blob.
        Uses optimistic concurrency - the request must include the expected version.
      tags: [user-data]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserDataUpdate'
      responses:
        '200':
          description: User data updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserData'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Version conflict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConflictError'

  /contacts:
    get:
      operationId: listContacts
      summary: List contacts
      description: |
        Returns all accepted contacts with their public keys.
        Public keys are needed to encrypt locations to contacts.
      tags: [contacts]
      responses:
        '200':
          description: List of contacts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContactList'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /contacts/{contactId}:
    delete:
      operationId: removeContact
      summary: Remove contact
      description: |
        Removes a contact relationship. Both users lose access to each other's location.
        The other user is not notified.
      tags: [contacts]
      parameters:
        - $ref: '#/components/parameters/contactId'
      responses:
        '204':
          description: Contact removed
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /contacts/request:
    post:
      operationId: sendContactRequest
      summary: Send contact request
      description: |
        Sends a contact request to another user by email.
        If the recipient doesn't have an account, no request is created.
      tags: [contacts]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContactRequestCreate'
      responses:
        '201':
          description: Request sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContactRequest'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Request already exists or already contacts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /contacts/requests:
    get:
      operationId: listContactRequests
      summary: List contact requests
      description: Returns both incoming and outgoing pending contact requests.
      tags: [contacts]
      responses:
        '200':
          description: Contact requests
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContactRequestList'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /contacts/requests/{requestId}/accept:
    post:
      operationId: acceptContactRequest
      summary: Accept contact request
      description: |
        Accepts an incoming contact request.
        Both users become contacts and can share locations.
      tags: [contacts]
      parameters:
        - $ref: '#/components/parameters/requestId'
      responses:
        '200':
          description: Request accepted, returns new contact
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Contact'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /contacts/requests/{requestId}/decline:
    post:
      operationId: declineContactRequest
      summary: Decline contact request
      description: Declines an incoming contact request.
      tags: [contacts]
      parameters:
        - $ref: '#/components/parameters/requestId'
      responses:
        '204':
          description: Request declined
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /contacts/requests/{requestId}:
    delete:
      operationId: cancelContactRequest
      summary: Cancel contact request
      description: Cancels an outgoing contact request.
      tags: [contacts]
      parameters:
        - $ref: '#/components/parameters/requestId'
      responses:
        '204':
          description: Request cancelled
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /locations:
    get:
      operationId: getLocations
      summary: Get locations from contacts
      description: |
        Retrieves encrypted location blobs shared by contacts.
        Each blob is encrypted with NaCl box (sender's private key + recipient's public key).
      tags: [locations]
      responses:
        '200':
          description: Encrypted locations from contacts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationList'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      operationId: shareLocations
      summary: Share locations with contacts
      description: |
        Publishes encrypted location blobs to contacts.
        Each blob should be encrypted with NaCl box for the specific recipient.
      tags: [locations]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LocationShareRequest'
      responses:
        '204':
          description: Locations shared
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /devices:
    get:
      operationId: listDevices
      summary: List devices
      description: Returns all devices registered to the user's account.
      tags: [devices]
      responses:
        '200':
          description: List of devices
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeviceList'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      operationId: registerDevice
      summary: Register device
      description: |
        Registers a new device for the user's account.
        Returns a device token for subsequent API calls.
      tags: [devices]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeviceCreate'
      responses:
        '201':
          description: Device registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeviceWithToken'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /devices/{deviceId}:
    delete:
      operationId: revokeDevice
      summary: Revoke device
      description: |
        Revokes a device, preventing it from accessing the API.
        The device retains any locally cached data.
      tags: [devices]
      parameters:
        - $ref: '#/components/parameters/deviceId'
      responses:
        '204':
          description: Device revoked
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: |
        Bearer token authentication. Format: `Bearer {sessionToken}`

        For device-specific operations, include device token: `Bearer {sessionToken}:{deviceToken}`

  parameters:
    contactId:
      name: contactId
      in: path
      required: true
      description: Contact user ID
      schema:
        type: string

    requestId:
      name: requestId
      in: path
      required: true
      description: Contact request ID
      schema:
        type: string

    deviceId:
      name: deviceId
      in: path
      required: true
      description: Device ID
      schema:
        type: string

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Authentication required or invalid
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: Machine-readable error code
              example: "invalid_request"
            message:
              type: string
              description: Human-readable error message
              example: "Email is required"

    ConflictError:
      type: object
      required:
        - error
        - currentVersion
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              example: "version_conflict"
            message:
              type: string
              example: "Data has been modified by another device"
        currentVersion:
          type: integer
          description: Current version on server
          example: 5

    HealthResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [healthy]
        version:
          type: string
          description: Server version
          example: "1.0.0"

    GoogleLoginRequest:
      type: object
      required:
        - idToken
      properties:
        idToken:
          type: string
          description: Google OAuth ID token

    LoginResponse:
      type: object
      required:
        - token
        - user
      properties:
        token:
          type: string
          description: Session token for API authentication
        user:
          $ref: '#/components/schemas/User'
        isNewUser:
          type: boolean
          description: True if this is the user's first login

    User:
      type: object
      required:
        - id
        - email
        - name
        - createdAt
      properties:
        id:
          type: string
          description: Unique user identifier
          example: "usr_abc123"
        email:
          type: string
          format: email
          description: User's email address
        name:
          type: string
          description: Display name
          example: "John Doe"
        publicKey:
          type: string
          description: Base64-encoded X25519 public key
        hasIdentityBackup:
          type: boolean
          description: Whether user has stored an identity backup
        hasUserData:
          type: boolean
          description: Whether user has stored encrypted user data
        createdAt:
          type: string
          format: date-time
          description: Account creation timestamp

    IdentityBackup:
      type: object
      required:
        - algorithm
        - kdf
        - iterations
        - salt
        - iv
        - payload
      properties:
        algorithm:
          type: string
          enum: [AES-256-GCM]
          description: Encryption algorithm
        kdf:
          type: string
          enum: [PBKDF2-SHA256]
          description: Key derivation function
        iterations:
          type: integer
          minimum: 100000
          description: KDF iterations
          example: 100000
        salt:
          type: string
          description: Base64-encoded salt (16 bytes)
        iv:
          type: string
          description: Base64-encoded IV (12 bytes)
        payload:
          type: string
          description: Base64-encoded ciphertext of encrypted keypair

    PublicKeyRequest:
      type: object
      required:
        - publicKey
      properties:
        publicKey:
          type: string
          description: Base64-encoded X25519 public key (32 bytes)

    UserData:
      type: object
      required:
        - version
        - updatedAt
      properties:
        version:
          type: integer
          description: Version number for optimistic concurrency
          example: 1
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp
        blob:
          type: string
          description: |
            Base64-encoded encrypted blob containing named locations,
            contact permissions, and preferences.
            Encrypted with NaCl box to self (user's own keypair).

    UserDataUpdate:
      type: object
      required:
        - version
        - blob
      properties:
        version:
          type: integer
          description: Expected current version (for optimistic concurrency)
        blob:
          type: string
          description: Base64-encoded encrypted blob

    Contact:
      type: object
      required:
        - id
        - email
        - name
        - publicKey
        - createdAt
      properties:
        id:
          type: string
          description: Contact's user ID
        email:
          type: string
          format: email
        name:
          type: string
          description: Contact's display name
        publicKey:
          type: string
          description: Base64-encoded X25519 public key for encrypting locations
        createdAt:
          type: string
          format: date-time
          description: When the contact relationship was established

    ContactList:
      type: object
      required:
        - contacts
      properties:
        contacts:
          type: array
          items:
            $ref: '#/components/schemas/Contact'

    ContactRequest:
      type: object
      required:
        - id
        - email
        - status
        - createdAt
      properties:
        id:
          type: string
          description: Request ID
        email:
          type: string
          format: email
          description: Email of the other user
        name:
          type: string
          description: Name of the other user (if available)
        status:
          type: string
          enum: [pending, accepted, declined]
        direction:
          type: string
          enum: [incoming, outgoing]
          description: Whether this is an incoming or outgoing request
        createdAt:
          type: string
          format: date-time

    ContactRequestCreate:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          description: Email of the user to send request to

    ContactRequestList:
      type: object
      required:
        - incoming
        - outgoing
      properties:
        incoming:
          type: array
          items:
            $ref: '#/components/schemas/ContactRequest'
        outgoing:
          type: array
          items:
            $ref: '#/components/schemas/ContactRequest'

    EncryptedLocation:
      type: object
      required:
        - fromUserId
        - blob
        - updatedAt
      properties:
        fromUserId:
          type: string
          description: User ID who shared this location
        blob:
          type: string
          description: |
            Base64-encoded NaCl box ciphertext.
            Encrypted with sender's private key + recipient's public key.
            Contains location hierarchy, optional named location, and timestamp.
        updatedAt:
          type: string
          format: date-time
          description: When the location was last updated

    LocationList:
      type: object
      required:
        - locations
      properties:
        locations:
          type: array
          items:
            $ref: '#/components/schemas/EncryptedLocation'

    LocationShare:
      type: object
      required:
        - toUserId
        - blob
      properties:
        toUserId:
          type: string
          description: User ID to share location with
        blob:
          type: string
          description: Base64-encoded NaCl box ciphertext for this recipient

    LocationShareRequest:
      type: object
      required:
        - locations
      properties:
        locations:
          type: array
          items:
            $ref: '#/components/schemas/LocationShare'

    Device:
      type: object
      required:
        - id
        - name
        - platform
        - createdAt
        - lastSeen
      properties:
        id:
          type: string
          description: Device ID
        name:
          type: string
          description: User-friendly device name
          example: "My iPhone"
        platform:
          type: string
          enum: [ios, android, web, cli]
        createdAt:
          type: string
          format: date-time
        lastSeen:
          type: string
          format: date-time
        isCurrent:
          type: boolean
          description: Whether this is the current device making the request
        isRevoked:
          type: boolean
          description: Whether this device has been revoked

    DeviceCreate:
      type: object
      required:
        - name
        - platform
      properties:
        name:
          type: string
          description: User-friendly device name
          example: "My iPhone"
        platform:
          type: string
          enum: [ios, android, web, cli]

    DeviceWithToken:
      allOf:
        - $ref: '#/components/schemas/Device'
        - type: object
          required:
            - token
          properties:
            token:
              type: string
              description: Device token for API authentication

    DeviceList:
      type: object
      required:
        - devices
      properties:
        devices:
          type: array
          items:
            $ref: '#/components/schemas/Device'
