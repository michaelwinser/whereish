<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2d3748">
    <meta name="description" content="Privacy-first semantic location sharing">
    <!-- Security headers (frame protection requires HTTP headers, not meta tags) -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://accounts.google.com; style-src 'self' 'unsafe-inline' https://accounts.google.com; connect-src 'self' https://nominatim.openstreetmap.org https://accounts.google.com https://oauth2.googleapis.com; frame-src https://accounts.google.com; img-src 'self' data:;">
    <title>Whereish</title>
    <!-- Google Identity Services for OAuth (loaded from Google CDN for security) -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Install Banner (Android/Chrome) -->
    <div id="install-banner" class="install-banner hidden">
        <div class="install-banner-content">
            <span class="install-banner-icon">üì≤</span>
            <div class="install-banner-text">
                <strong>Install Whereish</strong>
                <span>Quick access from your home screen</span>
            </div>
        </div>
        <div class="install-banner-actions">
            <button id="install-btn" class="btn btn-primary btn-small">Install</button>
            <button id="install-dismiss-btn" class="btn btn-small">Later</button>
        </div>
    </div>

    <!-- iOS Install Instructions -->
    <div id="ios-install-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Install Whereish</h2>
                <button id="ios-install-close-btn" class="modal-close">&times;</button>
            </div>
            <div class="modal-body ios-install-instructions">
                <p>Install this app on your iPhone for quick access:</p>
                <ol>
                    <li>Tap the <strong>Share</strong> button <span class="ios-share-icon">‚éô</span> at the bottom of Safari</li>
                    <li>Scroll down and tap <strong>"Add to Home Screen"</strong></li>
                    <li>Tap <strong>"Add"</strong> in the top right</li>
                </ol>
                <div class="modal-actions">
                    <button id="ios-install-done-btn" class="btn btn-primary">Got it</button>
                </div>
            </div>
        </div>
    </div>

    <div class="app">
        <!-- Welcome View (logged-out entry point) -->
        <section class="view hidden" data-view="welcome" id="view-welcome">
            <div class="welcome-screen">
                <header class="welcome-header">
                    <h1 class="logo">Whereish</h1>
                    <p class="welcome-tagline">Privacy-first location sharing</p>
                </header>

                <div class="welcome-location">
                    <p class="welcome-label">You are at:</p>
                    <div id="welcome-hierarchy" class="welcome-hierarchy">
                        <div class="welcome-hierarchy-level">
                            <span class="welcome-hierarchy-icon">üìç</span>
                            <span class="welcome-hierarchy-text">Locating...</span>
                        </div>
                    </div>
                </div>

                <p class="welcome-pitch">
                    Share as much or as little as you want with each contact.
                </p>

                <div class="welcome-actions">
                    <!-- Google Sign-In (primary) -->
                    <div id="google-signin-container"></div>
                    <button id="google-signin-btn" class="btn btn-google">
                        <svg class="google-icon" viewBox="0 0 24 24" width="18" height="18">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Sign in with Google
                    </button>

                    <!-- Legacy login for existing users -->
                    <div class="welcome-legacy">
                        <p class="welcome-legacy-text">Existing user with password?</p>
                        <button id="welcome-login-btn" class="btn btn-link">Log in with email</button>
                    </div>

                    <!-- Transfer from another device -->
                    <div class="welcome-transfer">
                        <p class="welcome-transfer-text">Have another device signed in?</p>
                        <button id="welcome-transfer-btn" class="btn btn-link">Add device by code</button>
                    </div>
                </div>

                <div class="welcome-import">
                    <p class="welcome-import-text">Have a backup file?</p>
                    <button id="import-identity-btn" class="btn btn-link">Import Identity File</button>
                    <input type="file" id="identity-file-input" accept=".json" class="hidden">
                </div>
            </div>
        </section>

        <!-- Main View (logged-in home screen) -->
        <section class="view hidden" data-view="main" id="view-main">
            <header class="header">
                <h1 class="logo">Whereish</h1>
                <button id="settings-btn" class="settings-btn" aria-label="Settings">
                    <span class="settings-icon">&#9881;</span>
                </button>
                <p class="tagline">You are at</p>
            </header>

            <!-- Server Status Banner -->
            <div id="server-status" class="server-status hidden">
                <span class="server-status-icon">‚ö†Ô∏è</span>
                <span class="server-status-text">Backend server not connected</span>
            </div>

            <main class="main">
            <!-- Compact Location Bar -->
            <div id="location-bar" class="location-bar">
                <span class="location-bar-icon">üìç</span>
                <div class="location-bar-content">
                    <span class="location-bar-primary" id="location-bar-primary">Locating...</span>
                    <span class="location-bar-secondary hidden" id="location-bar-secondary"></span>
                </div>
                <div class="location-bar-actions">
                    <button id="save-location-btn" class="btn-icon" title="Save Location" disabled>üíæ</button>
                    <button id="refresh-btn" class="btn-icon" title="Refresh" disabled>üîÑ</button>
                </div>
            </div>

            <!-- Location Error (shown when location fails) -->
            <div id="error-message" class="location-error hidden">
                <p class="error-text"></p>
                <button id="retry-btn" class="btn btn-small">Try Again</button>
            </div>

            <!-- Hidden elements for backwards compatibility -->
            <div id="location-display" class="hidden">
                <div id="status" class="hidden"><span class="status-text"></span></div>
                <div id="named-location-match" class="hidden"><span class="named-match-label"></span></div>
                <div id="location-hierarchy" class="hidden"></div>
            </div>

            <!-- Contacts Section -->
            <section id="contacts-section" class="contacts-section hidden">
                <div class="section-header">
                    <h2>Contacts</h2>
                    <div class="section-header-actions">
                        <button id="add-contact-btn" class="btn-icon" title="Add Contact">+</button>
                        <button id="refresh-contacts-btn" class="btn-icon" title="Refresh">üîÑ</button>
                    </div>
                </div>
                <!-- Pending requests -->
                <div id="pending-requests" class="pending-requests hidden">
                    <div id="incoming-requests"></div>
                    <div id="outgoing-requests"></div>
                </div>
                <div id="contacts-list" class="contacts-list">
                    <p class="empty-state">Loading contacts...</p>
                </div>
            </section>

            <!-- Info Section -->
            <section class="info">
                <details>
                    <summary>How it works</summary>
                    <p>
                        Whereish shows your location as meaningful labels, not coordinates.
                        Your exact position stays on your device - we only display
                        human-readable places like "Seattle, Washington."
                    </p>
                    <p>
                        <strong>Named places:</strong> Save locations with custom names like
                        "Home" or "Office". When you're at a saved place, you'll see its
                        name instead of just the address.
                    </p>
                    <p>
                        <strong>Contacts:</strong> See where your contacts are. Their location
                        is filtered based on the permission level they've granted you. Use the
                        "Share" dropdown to control what each contact can see of your location.
                    </p>
                    <p>
                        <strong>Privacy note:</strong> This prototype uses OpenStreetMap
                        for geocoding. Production version will use on-device geocoding.
                    </p>
                </details>
            </section>
            </main>

            <footer class="footer">
                <p>Planet Earth, at minimum</p>
            </footer>
        </section>
        <!-- End Main View -->

        <!-- Places View -->
        <section class="view hidden" data-view="places" id="view-places">
            <header class="screen-header">
                <h1>My Places</h1>
            </header>
            <main class="main">
                <section class="places-content">
                    <div id="places-list" class="named-locations-list">
                        <p class="empty-state">No saved places yet. Save your current location to get started.</p>
                    </div>
                </section>
            </main>
        </section>
        <!-- End Places View -->

        <!-- Contact Detail View -->
        <section class="view hidden" data-view="contact-detail" id="view-contact-detail">
            <header class="screen-header">
                <button class="back-btn" id="contact-detail-back-btn" aria-label="Back">&larr;</button>
                <h1 id="contact-detail-name">Contact</h1>
            </header>
            <main class="main detail-content">
                <!-- Contact Info -->
                <div class="contact-detail-header">
                    <div class="contact-avatar-large" id="contact-avatar-large">?</div>
                    <div class="contact-detail-info">
                        <div class="contact-detail-fullname" id="contact-detail-fullname">Name</div>
                        <div class="contact-detail-email" id="contact-detail-email">email@example.com</div>
                    </div>
                </div>

                <!-- Their Location -->
                <section class="detail-section">
                    <h2 class="detail-section-title">Their Location</h2>
                    <div id="contact-location-display" class="contact-location-display">
                        <span class="location-text">Unknown</span>
                    </div>
                    <div id="contact-distance" class="contact-distance"></div>
                    <div id="contact-last-updated" class="contact-last-updated"></div>
                    <a id="open-in-maps-link" class="open-in-maps-link hidden" href="#" target="_blank" rel="noopener">Open in Maps</a>
                </section>

                <!-- What They See of You -->
                <section class="detail-section">
                    <h2 class="detail-section-title">What <span class="contact-first-name">They</span> Sees of You</h2>
                    <div class="permission-control-detail">
                        <label for="detail-permission-select">Share level:</label>
                        <select id="detail-permission-select" class="permission-select">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div id="permission-preview" class="permission-preview">
                        <span class="preview-label">Preview:</span>
                        <span class="preview-value" id="permission-preview-value">--</span>
                    </div>
                </section>

                <!-- What You See of Them -->
                <section class="detail-section">
                    <h2 class="detail-section-title">What You See of <span class="contact-first-name">Them</span></h2>
                    <div class="permission-info">
                        <span id="received-permission-level" class="permission-received">Unknown</span>
                    </div>
                </section>

                <!-- Actions -->
                <section class="detail-section detail-actions">
                    <button id="remove-contact-btn" class="btn btn-danger">Remove Contact</button>
                </section>
            </main>
        </section>
        <!-- End Contact Detail View -->

        <!-- Settings View -->
        <section class="view hidden" data-view="settings" id="view-settings">
            <header class="screen-header">
                <button class="back-btn" id="settings-back-btn" aria-label="Back">&larr;</button>
                <h1>Settings</h1>
            </header>
            <main class="main settings-content">
                <!-- Account Section -->
                <section class="settings-section">
                    <h2 class="settings-section-title">Account</h2>
                    <div class="settings-item">
                        <span class="settings-item-label">Signed in as</span>
                        <span class="settings-item-value" id="settings-user-email">--</span>
                    </div>
                    <button id="settings-logout-btn" class="btn btn-secondary settings-logout">Log Out</button>
                    <div class="settings-danger-zone">
                        <button id="delete-account-btn" class="btn btn-danger">Delete Account</button>
                        <p class="settings-hint">
                            Permanently delete your account and all data from the server.
                        </p>
                    </div>
                </section>

                <!-- Identity Section (E2E Encryption) -->
                <section class="settings-section">
                    <h2 class="settings-section-title">
                        Identity
                        <span class="encryption-badge">E2E Encrypted</span>
                    </h2>
                    <div class="settings-item">
                        <span class="settings-item-label">Encryption Status</span>
                        <span class="settings-item-value encryption-status">Active</span>
                    </div>
                    <p class="settings-hint encryption-info">
                        Your location data is end-to-end encrypted. Only your contacts can see your location -
                        not even Whereish servers can read it.
                    </p>
                    <button id="export-identity-btn" class="btn btn-secondary">Export Identity Backup</button>
                    <p class="settings-hint">
                        <strong>Important:</strong> Save this file securely. You'll need it to log in on other devices
                        or recover your account. Without it, your encrypted data cannot be recovered.
                    </p>
                    <div class="settings-danger-zone">
                        <button id="delete-identity-btn" class="btn btn-danger">Clear Local Identity</button>
                        <p class="settings-hint">
                            Removes encryption keys from this device only. Your server account remains intact.
                            Use when switching accounts or wiping this device.
                        </p>
                    </div>
                </section>

                <!-- Devices Section -->
                <section class="settings-section">
                    <h2 class="settings-section-title">Devices</h2>
                    <p class="settings-hint">
                        Manage devices linked to your account. Only the active device shares your location.
                    </p>
                    <div id="devices-list" class="devices-list">
                        <!-- Devices populated dynamically -->
                    </div>
                    <div id="devices-loading" class="devices-loading">Loading devices...</div>
                    <div id="devices-empty" class="devices-empty hidden">
                        No devices registered yet.
                    </div>
                    <button id="transfer-to-device-btn" class="btn btn-secondary settings-transfer-btn">
                        Transfer Identity to Another Device
                    </button>
                    <p class="settings-hint">
                        Add your identity to a new device by generating a transfer code.
                    </p>
                </section>

                <!-- Privacy Section (placeholders) -->
                <section class="settings-section">
                    <h2 class="settings-section-title">Privacy</h2>
                    <div class="settings-item settings-item-disabled">
                        <span class="settings-item-label">Go Dark</span>
                        <span class="settings-item-hint">Coming soon <!-- GitHub Issue #7 --></span>
                    </div>
                    <div class="settings-item settings-item-disabled">
                        <span class="settings-item-label">Sharing Summary</span>
                        <span class="settings-item-hint">Coming soon <!-- GitHub Issue #8 --></span>
                    </div>
                </section>

                <!-- About Section -->
                <section class="settings-section">
                    <h2 class="settings-section-title">About</h2>
                    <div class="settings-item">
                        <span class="settings-item-label">Version</span>
                        <span class="settings-item-value" id="settings-version">--</span>
                    </div>
                    <div class="settings-item">
                        <span class="settings-item-label">Build</span>
                        <span class="settings-item-value settings-item-value-small" id="settings-build">--</span>
                    </div>
                    <div class="settings-item">
                        <span class="settings-item-label">Privacy-first location sharing</span>
                    </div>
                    <button id="force-refresh-btn" class="btn btn-secondary settings-refresh">Force Refresh</button>
                </section>
            </main>
        </section>
        <!-- End Settings View -->

        <!-- Delete Account View -->
        <section class="view hidden" data-view="delete-account" id="view-delete-account">
            <header class="screen-header">
                <button id="delete-account-back-btn" class="back-btn" aria-label="Back">
                    <span class="back-icon">‚Üê</span>
                </button>
                <h1>Delete Account</h1>
            </header>
            <div class="settings-content">
                <div class="delete-account-warning">
                    <h2>This action cannot be undone</h2>
                    <p>Deleting your account will permanently remove:</p>
                    <ul>
                        <li>Your account and login credentials</li>
                        <li>All your contacts and location sharing settings</li>
                        <li>All named locations you've saved</li>
                        <li>Your encryption identity on this device</li>
                    </ul>
                </div>
                <form id="delete-account-form" class="delete-account-form">
                    <div class="form-group">
                        <label for="delete-account-password">Enter your password to confirm</label>
                        <input type="password" id="delete-account-password" name="password" required autocomplete="current-password">
                    </div>
                    <div id="delete-account-error" class="form-error hidden"></div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-danger btn-full-width">Permanently Delete My Account</button>
                    </div>
                    <div class="form-group">
                        <button type="button" id="delete-account-cancel-btn" class="btn btn-secondary btn-full-width">Cancel</button>
                    </div>
                </form>
            </div>
        </section>
        <!-- End Delete Account View -->

        <!-- Tab Bar (only visible when logged in) -->
        <nav class="tab-bar hidden" id="tab-bar" role="tablist" aria-label="Main navigation">
            <button class="tab-item active" data-tab="main" role="tab" aria-selected="true" aria-controls="view-main">
                <span class="tab-icon" aria-hidden="true">üë•</span>
                <span class="tab-label">Contacts</span>
            </button>
            <button class="tab-item" data-tab="places" role="tab" aria-selected="false" aria-controls="view-places">
                <span class="tab-icon" aria-hidden="true">üìç</span>
                <span class="tab-label">Places</span>
            </button>
            <!-- GitHub Issue #6 -->
            <button class="tab-item" data-tab="circles" role="tab" aria-selected="false" disabled aria-disabled="true">
                <span class="tab-icon" aria-hidden="true">‚≠ï</span>
                <span class="tab-label">Circles</span>
            </button>
        </nav>
    </div>

    <!-- Modal for saving location -->
    <div id="save-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Save This Place</h2>
                <button id="modal-close-btn" class="modal-close">&times;</button>
            </div>
            <form id="save-location-form" class="modal-body">
                <div class="form-group">
                    <label for="location-label">Name</label>
                    <input
                        type="text"
                        id="location-label"
                        name="label"
                        placeholder="e.g., Home, Office, Gym"
                        required
                        maxlength="50"
                        autocomplete="off"
                    >
                </div>
                <div class="form-group">
                    <label for="location-radius">Radius</label>
                    <select id="location-radius" name="radius">
                        <option value="150" selected>Street (~150m)</option>
                        <option value="750">Neighborhood (~750m)</option>
                        <option value="10000">City (~10km)</option>
                    </select>
                    <p class="form-help">How close do you need to be to count as "here"?</p>
                </div>
                <div class="form-group">
                    <label>Current Location</label>
                    <p id="modal-current-location" class="form-static">Loading...</p>
                </div>
                <div class="modal-actions">
                    <button type="button" id="modal-cancel-btn" class="btn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Place</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="auth-modal-title">Log In</h2>
                <button id="auth-modal-close-btn" class="modal-close">&times;</button>
            </div>
            <form id="auth-form" class="modal-body">
                <div id="auth-name-group" class="form-group hidden">
                    <label for="auth-name">Name</label>
                    <input type="text" id="auth-name" name="name" placeholder="Your name" autocomplete="name">
                </div>
                <div class="form-group">
                    <label for="auth-email">Email</label>
                    <input type="email" id="auth-email" name="email" placeholder="you@example.com" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="auth-password">Password</label>
                    <input type="password" id="auth-password" name="password" placeholder="Password" required autocomplete="current-password" minlength="6">
                </div>
                <div id="auth-confirm-group" class="form-group hidden">
                    <label for="auth-confirm-password">Confirm Password</label>
                    <input type="password" id="auth-confirm-password" name="confirm-password" placeholder="Confirm password" autocomplete="new-password" minlength="6">
                </div>
                <div class="form-group form-group-inline">
                    <label class="checkbox-label">
                        <input type="checkbox" id="auth-show-password">
                        <span>Show password</span>
                    </label>
                </div>
                <div id="auth-error" class="form-error hidden"></div>
                <div id="auth-import-section" class="auth-import-section hidden">
                    <p>Have your identity backup file?</p>
                    <button type="button" id="auth-import-btn" class="btn btn-secondary">Import Identity</button>
                    <input type="file" id="auth-identity-file" accept=".json" class="hidden">
                </div>
                <div class="modal-actions">
                    <button type="submit" id="auth-submit-btn" class="btn btn-primary">Log In</button>
                </div>
                <p id="auth-switch" class="auth-switch">
                    Don't have an account? <a href="#" id="auth-switch-link">Sign up</a>
                </p>
            </form>
        </div>
    </div>

    <!-- PIN Setup Modal (for new users after OAuth) -->
    <div id="pin-setup-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Set Up Your PIN</h2>
            </div>
            <form id="pin-setup-form" class="modal-body">
                <p class="pin-setup-intro">
                    Create a PIN to protect your identity. You'll need this PIN to recover your account on a new device.
                </p>
                <div class="form-group">
                    <label for="pin-setup-pin">PIN (at least 6 digits)</label>
                    <input type="password" id="pin-setup-pin" name="pin" placeholder="Enter PIN" required minlength="6" maxlength="20" inputmode="numeric" autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label for="pin-setup-confirm">Confirm PIN</label>
                    <input type="password" id="pin-setup-confirm" name="confirm-pin" placeholder="Confirm PIN" required minlength="6" maxlength="20" inputmode="numeric" autocomplete="new-password">
                </div>
                <div class="form-group form-group-inline">
                    <label class="checkbox-label">
                        <input type="checkbox" id="pin-setup-show">
                        <span>Show PIN</span>
                    </label>
                </div>
                <div id="pin-setup-error" class="form-error hidden"></div>

                <div class="pin-backup-section">
                    <h3>Backup Options</h3>
                    <p class="pin-backup-text">How do you want to back up your identity?</p>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="pin-backup-download" checked>
                            <span>Download backup file (recommended)</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="pin-backup-server">
                            <span>Store encrypted backup on server</span>
                        </label>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="submit" id="pin-setup-btn" class="btn btn-primary">Continue</button>
                </div>
            </form>
        </div>
    </div>

    <!-- PIN Entry Modal (for importing encrypted identity) -->
    <div id="pin-entry-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Enter Your PIN</h2>
                <button id="pin-entry-close-btn" class="modal-close">&times;</button>
            </div>
            <form id="pin-entry-form" class="modal-body">
                <p class="pin-entry-intro">
                    This identity file is encrypted. Enter your PIN to decrypt it.
                </p>
                <div class="form-group">
                    <label for="pin-entry-pin">PIN</label>
                    <input type="password" id="pin-entry-pin" name="pin" placeholder="Enter PIN" required inputmode="numeric" autocomplete="current-password">
                </div>
                <div class="form-group form-group-inline">
                    <label class="checkbox-label">
                        <input type="checkbox" id="pin-entry-show">
                        <span>Show PIN</span>
                    </label>
                </div>
                <div id="pin-entry-error" class="form-error hidden"></div>
                <div class="modal-actions">
                    <button type="button" id="pin-entry-cancel-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" id="pin-entry-btn" class="btn btn-primary">Unlock</button>
                </div>
            </form>
        </div>
    </div>

    <!-- PIN Verification Modal (periodic check) -->
    <div id="pin-verify-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>PIN Reminder</h2>
            </div>
            <form id="pin-verify-form" class="modal-body">
                <p class="pin-verify-intro">
                    To make sure you can recover your account, please confirm your PIN.
                    This check happens periodically to help you remember it.
                </p>
                <div class="form-group">
                    <label for="pin-verify-pin">Enter Your PIN</label>
                    <input type="password" id="pin-verify-pin" name="pin" placeholder="Enter PIN" required inputmode="numeric" autocomplete="current-password">
                </div>
                <div class="form-group form-group-inline">
                    <label class="checkbox-label">
                        <input type="checkbox" id="pin-verify-show">
                        <span>Show PIN</span>
                    </label>
                </div>
                <div id="pin-verify-error" class="form-error hidden"></div>
                <div id="pin-verify-success" class="form-success hidden">PIN verified successfully!</div>
                <div class="modal-actions">
                    <button type="button" id="pin-verify-skip-btn" class="btn btn-secondary">Skip for now</button>
                    <button type="submit" id="pin-verify-btn" class="btn btn-primary">Verify PIN</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transfer Source Modal (shows code to share) -->
    <div id="transfer-source-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Transfer Identity</h2>
                <button id="transfer-source-close-btn" class="modal-close">&times;</button>
            </div>
            <div id="transfer-source-body" class="modal-body">
                <!-- Initial state: Show code -->
                <div id="transfer-source-pending" class="transfer-state">
                    <p class="transfer-intro">Share this code with your other device:</p>
                    <div class="transfer-code-display">
                        <span id="transfer-code">------</span>
                    </div>
                    <p class="transfer-hint">Code expires in <span id="transfer-expires">10</span> minutes</p>
                    <div class="transfer-status">
                        <span class="transfer-status-text">Waiting for device to connect...</span>
                    </div>
                </div>
                <!-- Claimed state: Device connected -->
                <div id="transfer-source-claimed" class="transfer-state hidden">
                    <p class="transfer-success-text">Device connected!</p>
                    <div class="transfer-device-info">
                        <span class="transfer-device-name" id="transfer-target-device">Unknown Device</span>
                    </div>
                    <p class="transfer-hint">Approve to send your identity to this device.</p>
                    <div class="form-group">
                        <label for="transfer-pin">Enter your PIN to approve:</label>
                        <input type="password" id="transfer-pin" placeholder="PIN" inputmode="numeric" autocomplete="current-password">
                    </div>
                    <div id="transfer-source-error" class="form-error hidden"></div>
                    <div class="modal-actions">
                        <button type="button" id="transfer-deny-btn" class="btn btn-secondary">Deny</button>
                        <button type="button" id="transfer-approve-btn" class="btn btn-primary">Approve Transfer</button>
                    </div>
                </div>
                <!-- Complete state -->
                <div id="transfer-source-complete" class="transfer-state hidden">
                    <p class="transfer-success-text">Transfer Complete!</p>
                    <p class="transfer-hint">Your identity has been transferred to the other device.</p>
                    <div class="modal-actions">
                        <button type="button" id="transfer-done-btn" class="btn btn-primary">Done</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="transfer-source-footer">
                <button type="button" id="transfer-cancel-btn" class="btn btn-secondary">Cancel Transfer</button>
            </div>
        </div>
    </div>

    <!-- Transfer Receive Modal (enter code) -->
    <div id="transfer-receive-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Device by Code</h2>
                <button id="transfer-receive-close-btn" class="modal-close">&times;</button>
            </div>
            <div id="transfer-receive-body" class="modal-body">
                <!-- Initial state: Enter code -->
                <div id="transfer-receive-enter" class="transfer-state">
                    <p class="transfer-intro">Enter the 6-digit code from your other device:</p>
                    <div class="form-group">
                        <input type="text" id="transfer-receive-code" maxlength="6" placeholder="000000" inputmode="numeric" autocomplete="one-time-code" class="transfer-code-input">
                    </div>
                    <div id="transfer-receive-error" class="form-error hidden"></div>
                    <div class="modal-actions">
                        <button type="button" id="transfer-receive-cancel-btn" class="btn btn-secondary">Cancel</button>
                        <button type="button" id="transfer-receive-submit-btn" class="btn btn-primary">Connect</button>
                    </div>
                </div>
                <!-- Waiting state: Waiting for approval -->
                <div id="transfer-receive-waiting" class="transfer-state hidden">
                    <p class="transfer-intro">Connected to:</p>
                    <div class="transfer-device-info">
                        <span class="transfer-device-name" id="transfer-source-user">Unknown User</span>
                        <span class="transfer-device-detail" id="transfer-source-device">Unknown Device</span>
                    </div>
                    <p class="transfer-hint">Waiting for approval from the other device...</p>
                    <div class="transfer-spinner"></div>
                </div>
                <!-- Enter PIN state -->
                <div id="transfer-receive-pin" class="transfer-state hidden">
                    <p class="transfer-success-text">Identity received!</p>
                    <p class="transfer-intro">Enter your PIN to decrypt and import the identity:</p>
                    <div class="form-group">
                        <input type="password" id="transfer-receive-pin-input" placeholder="PIN" inputmode="numeric" autocomplete="current-password">
                    </div>
                    <div id="transfer-receive-pin-error" class="form-error hidden"></div>
                    <div class="modal-actions">
                        <button type="button" id="transfer-receive-pin-btn" class="btn btn-primary">Import Identity</button>
                    </div>
                </div>
                <!-- Complete state -->
                <div id="transfer-receive-complete" class="transfer-state hidden">
                    <p class="transfer-success-text">Transfer Complete!</p>
                    <p class="transfer-hint">Your identity has been imported. You can now sign in.</p>
                    <div class="modal-actions">
                        <button type="button" id="transfer-receive-done-btn" class="btn btn-primary">Continue</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div id="add-contact-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Contact</h2>
                <button id="add-contact-close-btn" class="modal-close">&times;</button>
            </div>
            <form id="add-contact-form" class="modal-body">
                <div class="form-group">
                    <label for="contact-email">Email Address</label>
                    <input type="email" id="contact-email" name="email" placeholder="friend@example.com" required>
                    <p class="form-help">Enter the email address of the person you want to add</p>
                </div>
                <div id="add-contact-error" class="form-error hidden"></div>
                <div class="modal-actions">
                    <button type="button" id="add-contact-cancel-btn" class="btn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Request</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Place Modal -->
    <div id="edit-place-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <h2>Edit Place</h2>
                <button id="edit-place-close-btn" class="modal-close">&times;</button>
            </div>
            <form id="edit-place-form" class="modal-body">
                <div class="form-group">
                    <label for="edit-place-label">Name</label>
                    <input
                        type="text"
                        id="edit-place-label"
                        name="label"
                        placeholder="e.g., Home, Office, Gym"
                        required
                        maxlength="50"
                        autocomplete="off"
                    >
                </div>
                <div class="form-group">
                    <label for="edit-place-radius">Radius</label>
                    <select id="edit-place-radius" name="radius">
                        <option value="150">Street (~150m)</option>
                        <option value="750">Neighborhood (~750m)</option>
                        <option value="10000">City (~10km)</option>
                    </select>
                    <p class="form-help">How close do you need to be to count as "here"?</p>
                </div>
                <div class="form-group visibility-section">
                    <label>Who can see this place?</label>
                    <p class="form-help">Control who sees the place name when you're here. This is separate from your geographic sharing level.</p>
                    <div class="visibility-options">
                        <label class="radio-option">
                            <input type="radio" name="visibility" value="private" checked>
                            <span class="radio-label">Nobody</span>
                            <span class="radio-desc">Keep this place private</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="visibility" value="all">
                            <span class="radio-label">All contacts</span>
                            <span class="radio-desc">Everyone can see when you're here</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="visibility" value="selected">
                            <span class="radio-label">Specific contacts</span>
                            <span class="radio-desc">Choose who can see</span>
                        </label>
                    </div>
                    <div id="visibility-contact-selector" class="contact-selector hidden">
                        <p class="empty-state">Loading contacts...</p>
                    </div>
                </div>
                <div id="edit-place-error" class="form-error hidden"></div>
                <div class="modal-actions">
                    <button type="button" id="edit-place-cancel-btn" class="btn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts (order matters) -->
    <!-- Crypto dependencies (bundled locally for offline PWA support) -->
    <script src="nacl-fast.min.js"></script>
    <script src="nacl-util.min.js"></script>
    <!-- App modules -->
    <script src="version.js"></script>
    <script src="crypto.js"></script>
    <script src="pin-crypto.js"></script>
    <script src="identity.js"></script>
    <script src="events.js"></script>
    <script src="storage.js"></script>
    <script src="geofence.js"></script>
    <script src="api.js"></script>
    <script src="model.js"></script>
    <script src="views.js"></script>
    <script src="ui.js"></script>
    <script src="app.js"></script>

    <!-- Development-only testing module -->
    <script>
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
            const script = document.createElement('script');
            script.src = 'testing.js';
            document.body.appendChild(script);
        }
    </script>
</body>
</html>
